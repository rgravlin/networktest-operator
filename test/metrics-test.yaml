apiVersion: v1
kind: Pod
metadata:
  name: metrics-consumer
  namespace: networktest-operator-system
spec:
  # Use the scaffolded service account name to allow authn/authz
  serviceAccountName: networktest-operator-controller-manager
  containers:
  - name: metrics-consumer
    image: curlimages/curl:7.78.0
    command: ["/bin/sh"]
    args:
      - "-c"
      - >
        while true;
        do
          # Note here that we are passing the token obtained from the ServiceAccount to curl the metrics endpoint
          curl -s -k -H "Authorization: Bearer $(cat /var/run/secrets/kubernetes.io/serviceaccount/token)" \
          https://networktest-operator-controller-manager-metrics-service.networktest-operator-system.svc.cluster.local:8443/metrics;
          sleep 60;
        done